@page "/boards/{boardId:int}/issues"
@attribute [Authorize]
@inject BoardsHttpClient BoardsClient
@inject IssuesHttpClient IssuesClient
@using SimpleBoards.Core.Models;
@using System.Linq;

@if (viewModel.Board is null)
{
    <h4>Loading...</h4>
}
else 
{
    <div class="row">
        <div class="col">
            <h2>@viewModel.Board?.Name</h2>
        </div>
        <div class="col-auto">
            <a href="boards/@BoardId/issues/new" class="btn btn-primary">New issue</a>
        </div>
    </div>
    <div class="row">
        <div class="col col-issue">
            <h5>New</h5>
            <hr />
            @foreach (var issue in viewModel.NewIssues)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@issue.Title</h5>
                        <p class="card-text">@issue.Type</p>
                    </div>
                </div>
            }
        </div>
        <div class="col col-issue">
            <h5>To do</h5>
            <hr />
            @foreach (var issue in viewModel.AssignedIssues)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@issue.Title</h5>
                        <p class="card-text">@issue.Type</p>
                    </div>
                </div>
            }
        </div>
        <div class="col col-issue">
            <h5>In progress</h5>
            <hr />
            @foreach (var issue in viewModel.InProgressIssues)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@issue.Title</h5>
                        <p class="card-text">@issue.Type</p>
                    </div>
                </div>
            }
        </div>
        <div class="col col-issue">
            <h5>Testing</h5>
            <hr />
            @foreach (var issue in viewModel.TestingIssues)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@issue.Title</h5>
                        <p class="card-text">@issue.Type</p>
                    </div>
                </div>
            }
        </div>
        <div class="col col-issue">
            <h5>Done</h5>
            <hr />
            @foreach (var issue in viewModel.CompletedIssues)
            {
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@issue.Title</h5>
                        <p class="card-text">@issue.Type</p>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int BoardId { get; set; }

    private IssuesViewModel viewModel = new();

    public class IssuesViewModel
    {
        public BoardModel Board { get; set; }

        public List<IssuesListModel.IssueListItem> NewIssues { get; set; } = new();
        
        public List<IssuesListModel.IssueListItem> AssignedIssues { get; set; } = new();

        public List<IssuesListModel.IssueListItem> InProgressIssues { get; set; } = new();

        public List<IssuesListModel.IssueListItem> TestingIssues { get; set; } = new();

        public List<IssuesListModel.IssueListItem> CompletedIssues { get; set; } = new();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        viewModel.Board = await BoardsClient.GetBoardDetail(BoardId);

        var issues = await IssuesClient.GetIssuesList(BoardId);

        viewModel.NewIssues = issues.Issues.Where(i => i.State == Issue.IssueState.New.ToString()).ToList();
        viewModel.AssignedIssues = issues.Issues.Where(i => i.State == Issue.IssueState.ToDo.ToString()).ToList();
        viewModel.InProgressIssues = issues.Issues.Where(i => i.State == Issue.IssueState.InProgress.ToString()).ToList();
        viewModel.TestingIssues = issues.Issues.Where(i => i.State == Issue.IssueState.Testing.ToString()).ToList();
        viewModel.CompletedIssues = issues.Issues.Where(i => i.State == Issue.IssueState.Done.ToString()).ToList();
    }
}